
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parth's Secure Vault - Fixed</title>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #ffffff; --sender: #FFFDD0; --receiver: #E8E8E0; --accent: #000; }
        body { font-family: -apple-system, sans-serif; background: #121212; margin: 0; display: flex; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        #app-container { background: var(--bg); border: 4px solid #000; display: flex; overflow: hidden; box-shadow: 0 0 50px #000; }
        
        /* Responsive Logic */
        @media (max-width: 768px) {
            #app-container { width: 98vw; height: 95vh; flex-direction: column; border-radius: 20px; }
            #side-panel { display: none; }
            #mobile-video { display: grid; grid-template-columns: 1fr 1fr; background: #000; height: 120px; }
        }
        @media (min-width: 769px) {
            #app-container { width: 950px; height: 650px; flex-direction: row; border-radius: 12px; }
            #side-panel { width: 300px; background: #000; border-right: 2px solid #000; display: flex; flex-direction: column; }
            #mobile-video { display: none; }
        }

        video { width: 100%; height: 100%; object-fit: cover; background: #222; }
        #chat-section { flex: 1; display: flex; flex-direction: column; }
        #chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; }
        .msg { margin-bottom: 10px; padding: 10px; border-radius: 12px; max-width: 80%; font-size: 14px; }
        .you { align-self: flex-end; background: var(--sender); border: 1px solid #e0dbb0; }
        .peer { align-self: flex-start; background: var(--receiver); border: 1px solid #ccc; }
        .controls { background: #f4f4f4; padding: 10px; border-top: 1px solid #ddd; }
        .row { display: flex; gap: 5px; margin-bottom: 5px; }
        input, button { padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
        button { background: #000; color: #fff; cursor: pointer; font-weight: bold; }
        #auth-overlay { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div style="background:#1a1a1a; padding:30px; border-radius:15px; text-align:center;">
            <input type="password" id="login-pass" placeholder="Enter Password" style="margin-bottom:10px; width:200px;"><br>
            <button onclick="doLogin()">UNLOCK VAULT</button>
        </div>
    </div>

    <div id="app-container">
        <div id="side-panel">
            <video id="pc-local" autoplay muted playsinline></video>
            <video id="pc-remote" autoplay playsinline></video>
            <button onclick="shareScreen()">üñ•Ô∏è Share Screen</button>
        </div>

        <div id="chat-section">
            <div id="mobile-video">
                <video id="mob-local" autoplay muted playsinline></video>
                <video id="mob-remote" autoplay playsinline></video>
            </div>
            <div style="background:#000; color:#fff; padding:10px; text-align:center; font-size:12px;">
                MY ID: <span id="my-id">Connecting...</span>
            </div>
            <div id="chat-box"></div>
            <div class="controls">
                <div class="row">
                    <input type="number" id="target-id" class="flex-1" placeholder="Partner ID">
                    <button onclick="linkPeer()">LINK</button>
                </div>
                <div class="row">
                    <button class="flex-1" onclick="makeCall()">START VIDEO</button>
                    <button onclick="triggerWipe()" style="background:darkred;">WIPE</button>
                </div>
                <div class="row">
                    <input type="text" id="text-input" class="flex-1" placeholder="Type message...">
                    <button onclick="sendText()">SEND</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let peer, conn, localStream;
        const myPeerId = Math.floor(1000000000 + Math.random() * 9000000000).toString();

        function doLogin() {
            const p = document.getElementById('login-pass').value;
            if(!localStorage.getItem("v_pass")) localStorage.setItem("v_pass", p);
            if(p === localStorage.getItem("v_pass")) {
                document.getElementById('auth-overlay').style.display = 'none';
                initPeer();
            } else { alert("Wrong Password"); }
        }

        function initPeer() {
            // FIX: Added explicit Google STUN servers to bypass firewalls
            peer = new Peer(myPeerId, {
                config: { 'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' }
                ], 'sdpSemantics': 'unified-plan' }
            });

            peer.on('open', id => document.getElementById('my-id').innerText = id);
            
            // FIX: Ensure messages are received
            peer.on('connection', c => {
                conn = c;
                setupDataListeners();
            });

            // FIX: Auto-answer for video
            peer.on('call', async call => {
                const stream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                showLocal(stream);
                call.answer(stream);
                call.on('stream', remoteStream => showRemote(remoteStream));
            });
        }

        function linkPeer() {
            const tid = document.getElementById('target-id').value;
            conn = peer.connect(tid, { reliable: true });
            setupDataListeners();
        }

        function setupDataListeners() {
            conn.on('open', () => {
                appendMsg("System", "Linked!", "peer");
                conn.on('data', data => {
                    if(data === "WIPE") { localStorage.removeItem("v_chat"); location.reload(); }
                    else { appendMsg("Partner", data, "peer"); }
                });
            });
        }

        async function makeCall() {
            const tid = document.getElementById('target-id').value;
            const stream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
            showLocal(stream);
            const call = peer.call(tid, stream);
            call.on('stream', remoteStream => showRemote(remoteStream));
        }

        function showLocal(s) {
            document.getElementById('pc-local').srcObject = s;
            document.getElementById('mob-local').srcObject = s;
            localStream = s;
        }

        function showRemote(s) {
            document.getElementById('pc-remote').srcObject = s;
            document.getElementById('mob-remote').srcObject = s;
        }

        function sendText() {
            const val = document.getElementById('text-input').value;
            if(conn && val) {
                conn.send(val);
                appendMsg("You", val, "you");
                document.getElementById('text-input').value = "";
            }
        }

        function appendMsg(sender, text, cls) {
            const box = document.getElementById('chat-box');
            box.innerHTML += `<div class="msg ${cls}"><b>${sender}</b><br>${text}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        function triggerWipe() { if(conn) conn.send("WIPE"); localStorage.removeItem("v_chat"); location.reload(); }

        async function shareScreen() {
            const s = await navigator.mediaDevices.getDisplayMedia({video:true});
            showLocal(s);
            alert("Screen active. Click START VIDEO to share with partner.");
        }
    </script>
</body>
</html>
